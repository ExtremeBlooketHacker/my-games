<!DOCTYPE html>
<html>
<head>
    <style>
        body { background: #121212; color: #e0e0e0; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        #header { padding: 15px; background: #1e1e1e; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #333; }
        #chat-box { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; }
        .msg { background: #2d2d2d; padding: 8px 12px; border-radius: 12px; width: fit-content; max-width: 85%; border-bottom-left-radius: 2px; }
        .msg b { color: #007bff; font-size: 0.75rem; display: block; margin-bottom: 3px; }
        #input-area { padding: 15px; background: #1e1e1e; display: flex; gap: 10px; }
        input { flex-grow: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #262626; color: white; outline: none; }
        button { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        #online-tag { background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; }
    </style>
</head>
<body>

<div id="header">
    <div>
        <span id="online-tag">Online: <span id="count">1</span></span>
    </div>
    <button onclick="changeName()" style="background: #444; font-size: 0.8rem;">Edit Nickname</button>
</div>

<div id="chat-box" id="messages"></div>

<div id="input-area">
    <input type="text" id="msg-input" placeholder="Say something..." onkeypress="if(event.key==='Enter') send()">
    <button onclick="send()">Send</button>
</div>

<script src="https://cdn.ably.com/lib/ably.min-1.js"></script>

<script>
    // 1. GET A FREE API KEY at Ably.com
    const ably = new Ably.Realtime('EEkkWA.G6icog:T0iJzeqrPkW15N9A7JANivEDFWkKrTp2XmPlXoAzSS4');
    const channel = ably.channels.get('school-chat');

    // 2. NICKNAME PERSISTENCE
    let myName = localStorage.getItem('chat-name') || "Player" + Math.floor(Math.random() * 999);
    
    function changeName() {
        let n = prompt("Change your display name:", myName);
        if(n && n.trim().length > 0) {
            myName = n;
            localStorage.setItem('chat-name', n);
        }
    }

    // 3. SEND MESSAGE
    function send() {
        const input = document.getElementById('msg-input');
        if(input.value.trim() === "") return;

        channel.publish('message', {
            user: myName,
            text: input.value
        });
        input.value = "";
    }

    // 4. RECEIVE MESSAGE
    channel.subscribe('message', (msg) => {
        const chatBox = document.getElementById('chat-box');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'msg';
        msgDiv.innerHTML = `<b>${msg.data.user}</b> ${msg.data.text}`;
        chatBox.appendChild(msgDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    // 5. USER PRESENCE (WHO IS ONLINE)
    channel.presence.enter();
    channel.presence.get((err, members) => {
        document.getElementById('count').innerText = members.length;
    });
    channel.presence.subscribe('enter', () => updateCount());
    channel.presence.subscribe('leave', () => updateCount());

    function updateCount() {
        channel.presence.get((err, members) => {
            document.getElementById('count').innerText = members.length;
        });
    }
</script>
</body>
</html>