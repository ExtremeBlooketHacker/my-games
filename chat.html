<script>
    const ADMIN_PASSWORD = "1234"; 
    const uniqueId = 'user-' + Math.random().toString(36).substr(2, 9);
    
    const ably = new Ably.Realtime({
        key: 'EEkkWA.G6icog:T0iJzeqrPkW15N9A7JANivEDFWkKrTp2XmPlXoAzSS4',
        clientId: uniqueId,
        transports: ['xhr_polling', 'jsonp']
    });
    const channel = ably.channels.get('school-chat', { params: { rewind: '20' } });

    let myName = localStorage.getItem('chat-name') || "User" + Math.floor(Math.random() * 999);

    function send() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text) return;

        if (text.startsWith('/')) {
            const parts = text.split(/\s+/);
            const cmd = parts[0].toLowerCase();
            const pass = parts[1];
            const val = parts.slice(2).join(' ');

            if (pass === ADMIN_PASSWORD) {
                // ADDED: isLive flag to prevent history replays
                channel.publish('admin-cmd', { 
                    action: cmd.replace('/', ''), 
                    message: val,
                    isLive: true 
                });
                input.value = "";
                return;
            }
        }

        channel.publish('msg', {
            user: myName,
            text: text,
            timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
        });
        input.value = "";
    }

    channel.subscribe('msg', (m) => {
        const chatBox = document.getElementById('chat-box');
        const div = document.createElement('div');
        div.className = 'msg';
        div.innerHTML = `<div class="msg-header"><span class="username">${m.data.user}</span><span class="time">${m.data.timestamp}</span></div><div>${m.data.text}</div>`;
        chatBox.appendChild(div);
        chatBox.scrollTop = chatBox.scrollHeight;
    });

    channel.subscribe('admin-cmd', (cmd) => {
        // FIXED: Only execute if the command was sent LIVE (not from history)
        if (!cmd.data.isLive) return;

        const chatBox = document.getElementById('chat-box');
        const input = document.getElementById('msg-input');

        switch(cmd.data.action) {
            case 'clear': 
                chatBox.innerHTML = ""; 
                break;
            case 'alert': 
                alert("ADMIN: " + cmd.data.message); 
                break;
            case 'freeze': 
                input.disabled = true; 
                input.placeholder = "Chat Frozen..."; 
                break;
            case 'unfreeze': 
                input.disabled = false; 
                input.placeholder = "Type a message..."; 
                break;
            case 'party': 
                let i = 0, colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00'];
                let loop = setInterval(() => {
                    document.body.style.setProperty('background', colors[i % 4], 'important');
                    if(++i > 15) { 
                        clearInterval(loop); 
                        // FIXED: Re-apply theme variables directly from local storage
                        applyCurrentTheme();
                    }
                }, 100);
                break;
        }
    });

    // REUSABLE THEME FUNCTION
    function applyCurrentTheme() {
        const savedTheme = JSON.parse(localStorage.getItem('selected-theme'));
        if (savedTheme) {
            document.documentElement.style.setProperty('--bg', savedTheme.bg);
            document.documentElement.style.setProperty('--accent', savedTheme.accent);
            document.documentElement.style.setProperty('--text', savedTheme.text);
            document.body.style.background = "var(--bg)";
        }
    }

    // Sync from Portal
    window.addEventListener('message', (event) => {
        if (event.data.type === 'theme-update') {
            localStorage.setItem('selected-theme', JSON.stringify(event.data.theme));
            applyCurrentTheme();
        }
    });

    // Presence Logic
    channel.presence.enter({ name: myName });
    function refreshPresence() {
        channel.presence.get((err, members) => {
            if(!err) document.getElementById('count').innerText = members.length;
        });
    }
    channel.presence.subscribe(['enter', 'leave', 'update'], refreshPresence);
    setInterval(refreshPresence, 5000);

    function changeName() {
        let n = prompt("New Nickname:", myName);
        if(n) { myName = n; localStorage.setItem('chat-name', n); }
    }

    // Initial load
    applyCurrentTheme();
</script>